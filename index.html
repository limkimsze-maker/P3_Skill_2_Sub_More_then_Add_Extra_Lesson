<!doctype html>
<html lang="en">
<head>
  <!-- /standard (Kim Sze) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Method 2 ‚Äî Subtract more, then add the extra (‚àí9) ‚Äî Step-by-step Practice</title>

  <!-- ‚úÖ Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = "https://limkimsze-maker.github.io/SubtractMore_AddExtra_Method2/";
    try{
      const toDelete = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) toDelete.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) toDelete.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) toDelete.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) toDelete.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) toDelete.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID+"::")) toDelete.push(k);
        if(k.startsWith("UFCO-")) toDelete.push(k);
      }
      toDelete.forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });

      try{
        sessionStorage.removeItem("UFCO-audio-unlocked");
        sessionStorage.removeItem("UFCO-complete");
      }catch(e){}

      try{
        const bc = new BroadcastChannel("xapi-state");
        bc.postMessage({type:"clear", activityId: ACTIVITY_ID, ts: Date.now()});
        bc.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <style>
    :root{
      --bgA:#f6fbff; --bgB:#fff7ed;
      --card:rgba(255,255,255,.92);
      --ink:#0f172a; --muted:#64748b;
      --line:#e2e8f0;
      --good:#16a34a; --bad:#dc2626; --warn:#f59e0b;
      --accent:#0ea5e9; --accent2:#a855f7;
      --orange:#f59e0b; --blue:#0ea5e9;
      --shadow:0 18px 44px rgba(2,6,23,.12);
      --radius:18px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}

    html, body{
      width:100%; height:100%; margin:0;
      overflow:hidden;
      position:fixed;
      overscroll-behavior:none;
      touch-action:manipulation;
      font-family:var(--font);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 5%, rgba(14,165,233,.18), transparent 60%),
        radial-gradient(1200px 700px at 85% 10%, rgba(168,85,247,.14), transparent 60%),
        radial-gradient(900px 500px at 50% 90%, rgba(245,158,11,.10), transparent 62%),
        linear-gradient(180deg, var(--bgA), var(--bgB));
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(45deg,
        rgba(15,23,42,.03) 0 8px,
        rgba(15,23,42,0) 8px 16px);
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity:.28;
    }

    .viewport{
      position:fixed; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .stageWrap{ position:relative; width: 920px; height: 560px; overflow:hidden; }
    .stage{
      width: 920px; height: 560px;
      transform-origin: top left;
      will-change: transform;
      position:absolute; inset:0;
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      padding: 2px 8px 6px 8px;
      height: 42px;
    }
    .title{ font-weight:950; letter-spacing:.2px; line-height:1.05; font-size:17px; }
    .subtitle{ margin-top:2px; color:var(--muted); font-size:10px; line-height:1.15; }
    .badges{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:nowrap; }
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      box-shadow:0 10px 22px rgba(2,6,23,.08);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:flex; gap:7px; align-items:center;
      user-select:none;
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--warn); box-shadow:0 0 0 4px rgba(245,158,11,.18); }
    .dot.ok{ background:var(--good); box-shadow:0 0 0 4px rgba(22,163,74,.18); }

    .panel{
      margin: 0 8px 6px 8px;
      height: calc(100% - 48px);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:10px;
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(10px);
    }
    .panel:before{
      content:"";
      position:absolute;
      width:200px; height:200px;
      right:-80px; top:-80px;
      border-radius:56px;
      background: radial-gradient(circle at 30% 30%, rgba(14,165,233,.32), rgba(168,85,247,.16), transparent 70%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .layout{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 170px;
      gap:10px;
      align-items:stretch;
      position:relative;
      z-index:1;
      min-height:0;
      overflow:hidden;
    }

    .mainCard{
      height:100%;
      background: rgba(255,255,255,.94);
      border:1px solid var(--line);
      border-radius:16px;
      padding:8px;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr;
      gap:8px;
      min-height:0;
    }
    .qHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .eqBig{
      display:flex; align-items:baseline; gap:10px;
      flex-wrap:nowrap; white-space:nowrap;
      font-weight:950; letter-spacing:.2px;
      font-size:22px;
    }
    .eqBig .op{ color:var(--muted); font-weight:900; }
    .hint{
      color:var(--muted);
      font-size:10px;
      line-height:1.15;
      text-align:right;
      max-width: 370px;
    }

    .mid{
      min-height:0;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:10px;
      overflow:hidden;
    }

    .leftBoard{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      background:
        radial-gradient(700px 240px at 25% 40%, rgba(14,165,233,.10), transparent 60%),
        radial-gradient(700px 240px at 75% 40%, rgba(168,85,247,.10), transparent 60%),
        rgba(255,255,255,.96);
      overflow:hidden;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:10px;
      min-height:0;
    }

    /* (10) split into 9 and 1 (extra) */
    .bondRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:stretch;
      overflow:hidden;
    }
    .bondBox{
      width:100%;
      height:220px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.06);
      background: radial-gradient(520px 220px at 50% 30%, rgba(255,255,255,.95), rgba(255,255,255,.60));
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .workLines{
      display:grid;
      gap:6px;
      font-weight:900;
      font-size:16px;
      line-height:1.15;
      padding:2px 2px;
      color:#0f172a;
    }
    .workLines .dim{ color:var(--muted); font-weight:900; }
    .workLines .eqRow{ display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; }

    .finalPill{
      margin-top:auto;
      border-radius:16px;
      padding:12px 12px;
      background: rgba(14,165,233,.08);
      border:1px solid rgba(14,165,233,.18);
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      font-weight:950;
      font-size:22px;
      letter-spacing:.2px;
      overflow:hidden;
    }

    .stepsCol{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap:10px;
      overflow:hidden;
      min-height:0;
    }
    .stepCard{
      border-radius:16px;
      background:rgba(255,255,255,.96);
      border:2px solid var(--line);
      padding:10px 10px;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:6px;
      min-height:0;
    }
    .stepCard.orange{ border-color: rgba(245,158,11,.75); }
    .stepCard.blue{ border-color: rgba(14,165,233,.75); }

    .stepTitle{
      display:flex; gap:8px; align-items:baseline;
      font-weight:950; letter-spacing:.2px;
    }
    .stepTitle .label{ font-size:16px; text-decoration: underline; }
    .stepTitle.orange .label{ color: var(--orange); }
    .stepTitle.blue .label{ color: var(--blue); }

    .stepDesc{ font-weight:900; font-size:13px; color:var(--ink); }

    .stepEq{
      font-weight:950;
      font-size:15px;
      display:grid;
      gap:8px;
      align-content:start;
    }
    .stepEq .row{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap; }
    .stepEq .dim{ color:var(--muted); font-weight:900; }

    /* Inputs */
    input.blank{
      width:74px;
      height:30px;
      border-radius:12px;
      border:2px solid var(--line);
      padding:0 8px;
      font-size:15px;
      font-weight:950;
      text-align:center;
      outline:none;
      background:#fff;
      line-height:30px;
    }
    input.blank.tiny{ width:64px; }
    input.blank.mid{ width:78px; }
    input.blank:focus{
      border-color: rgba(14,165,233,.75);
      box-shadow:0 0 0 4px rgba(14,165,233,.16);
    }
    .okField{ border-color: rgba(22,163,74,.92)!important; box-shadow:0 0 0 4px rgba(22,163,74,.14)!important; }
    .badField{ border-color: rgba(220,38,38,.92)!important; box-shadow:0 0 0 4px rgba(220,38,38,.12)!important; }

    .pillNum{
      padding:6px 12px;
      border:2px solid rgba(22,163,74,.55);
      border-radius:999px;
      background:rgba(22,163,74,.08);
      font-weight:950;
      color:#0f172a;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:64px;
    }
    .pillNum.small{ padding:5px 10px; min-width:56px; font-size:14px; }

    /* Rail */
    button{
      border:1px solid var(--line);
      background:#fff;
      border-radius:13px;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 10px 18px rgba(2,6,23,.08);
      white-space:nowrap;
      touch-action:manipulation;
      user-select:none;
    }
    button.primary{
      background:linear-gradient(180deg, rgba(14,165,233,.96), rgba(14,165,233,.82));
      border-color: rgba(14,165,233,.6);
      color:#fff;
    }
    button.good{
      background:linear-gradient(180deg, rgba(22,163,74,.96), rgba(22,163,74,.82));
      border-color: rgba(22,163,74,.6);
      color:#fff;
    }
    button.ghost{ background:rgba(255,255,255,.78); }
    button.warn{
      background:linear-gradient(180deg, rgba(245,158,11,.96), rgba(245,158,11,.82));
      border-color: rgba(245,158,11,.6);
      color:#fff;
    }

    .rail{
      height:100%;
      background: rgba(255,255,255,.94);
      border:1px solid var(--line);
      border-radius:16px;
      padding:9px;
      overflow:hidden;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:8px;
      min-height:0;
    }
    .railTitle{
      font-weight:950;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .railBtns{ display:grid; gap:8px; align-content:start; }
    .railBtns button{
      width:100%;
      padding:10px 10px;
      font-size:12px;
      border-radius:14px;
    }
    .railFooter{ display:grid; gap:8px; }
    .feedback{
      border:1px solid var(--line);
      border-radius:14px;
      padding:8px 9px;
      background: rgba(255,255,255,.88);
      color:var(--muted);
      font-size:10.8px;
      line-height:1.25;
      height:102px;
      overflow:hidden;
    }
    .feedback strong{ color:var(--ink); }
    .creditInline{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      text-align:center;
      user-select:none;
    }

    .confetti{
      position:fixed; inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 9999;
    }
    .confetti i{
      position:absolute; top:-12px;
      width:10px; height:14px;
      border-radius:3px;
      opacity:.95;
      animation: fall 1100ms linear forwards;
    }
    @keyframes fall{
      to{ transform: translateY(110vh) rotate(260deg); opacity:1; }
    }

    /* Mobile */
    #panel.smallMode .layout{ grid-template-columns: 1fr; }
    #panel.smallMode .hint{ display:none; }
    #panel.smallMode .mid{ grid-template-columns: 1fr; }
    #panel.smallMode .stepsCol{ grid-template-rows: auto auto; }
    #panel.smallMode .rail{ grid-template-rows: auto auto; height:auto; }
    #panel.smallMode .railBtns{ grid-template-columns: repeat(3, 1fr); gap:8px; }
    #panel.smallMode .railFooter{ grid-template-columns: 1fr 1fr; align-items:stretch; }
    #panel.smallMode .bondBox{ height:200px; }

    #xapiBase{ display:none!important; }

    /* ‚úÖ Back to Main Menu button (bottom centre, non-blocking) */
    #mainMenuBtn{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(10px + env(safe-area-inset-bottom));
      z-index: 50;
      padding: 10px 14px;
      font-size: 12px;
      border-radius: 14px;
      backdrop-filter: blur(8px);
    }
  </style>
</head>

<body>
  <div class="viewport">
    <div class="stageWrap" id="stageWrap">
      <div class="stage" id="stage">

        <div class="topbar">
          <div>
            <div class="title">Subtraction Technique 2: Subtract more, then add the Extra)</div>
            <div class="subtitle">Best for subtracting 9: do ‚Äú‚àí10, then +1‚Äù.</div>
          </div>
          <div class="badges">
            <div class="pill"><span class="dot" id="statusDot"></span><span id="statusText">Not checked</span></div>
            <div class="pill"><span id="showingText">Showing 0/3</span></div>
            <div class="pill"><span style="font-weight:950">Score</span> <span id="scorePill">0</span></div>
          </div>
        </div>

        <div class="panel" id="panel">
          <div class="layout">

            <!-- MAIN -->
            <div class="mainCard">
              <div class="qHeader">
                <div class="eqBig" aria-label="question equation">
                  <span id="M">30</span>
                  <span class="op">‚àí</span>
                  <span id="S">9</span>
                </div>
                <div class="hint" id="hintText">Tip: Do <b>M ‚àí 10</b> first, then add <b>1</b> back.</div>
              </div>

              <div class="mid">
                <!-- LEFT -->
                <div class="leftBoard">
                  <!-- 10 split into 9 and 1 -->
                  <div class="bondRow">
                    <div class="bondBox" aria-label="ten split">
                      <svg viewBox="0 0 520 220" width="100%" height="220" role="img" aria-label="Split 10 into 9 and 1">
                        <defs>
                          <linearGradient id="gLine" x1="0" x2="1">
                            <stop offset="0" stop-color="rgba(14,165,233,0.95)"/>
                            <stop offset="1" stop-color="rgba(168,85,247,0.92)"/>
                          </linearGradient>
                          <radialGradient id="gNode" cx="30%" cy="30%">
                            <stop offset="0" stop-color="#ffffff"/>
                            <stop offset="1" stop-color="rgba(240,253,250,0.94)"/>
                          </radialGradient>
                          <filter id="shadow" x="-30%" y="-30%" width="160%" height="160%">
                            <feDropShadow dx="0" dy="7" stdDeviation="9" flood-color="rgba(2,6,23,0.16)"/>
                          </filter>
                        </defs>

                        <path d="M260 55 C210 88, 170 125, 145 160" fill="none" stroke="url(#gLine)" stroke-width="10" stroke-linecap="round" opacity="0.9"/>
                        <path d="M260 55 C310 88, 350 125, 375 160" fill="none" stroke="url(#gLine)" stroke-width="10" stroke-linecap="round" opacity="0.9"/>

                        <!-- TOP 10 -->
                        <g filter="url(#shadow)">
                          <circle cx="260" cy="55" r="44" fill="url(#gNode)" stroke="rgba(14,165,233,0.55)" stroke-width="8"/>
                          <text x="260" y="63" text-anchor="middle" font-size="26" font-weight="950" fill="#0f172a">10</text>
                        </g>

                        <!-- LEFT 9 -->
                        <g filter="url(#shadow)">
                          <circle cx="145" cy="160" r="52" fill="url(#gNode)" stroke="rgba(245,158,11,0.55)" stroke-width="9"/>
                          <text x="145" y="136" text-anchor="middle" font-size="12" font-weight="900" fill="#64748b">subtract</text>
                          <text x="145" y="176" text-anchor="middle" font-size="26" font-weight="950" fill="#0f172a">9</text>
                        </g>

                        <!-- RIGHT extra (1) -->
                        <g filter="url(#shadow)">
                          <circle cx="375" cy="160" r="52" fill="url(#gNode)" stroke="rgba(14,165,233,0.55)" stroke-width="9"/>
                          <text x="375" y="136" text-anchor="middle" font-size="12" font-weight="900" fill="#64748b">extra</text>
                          <foreignObject x="332" y="146" width="90" height="56">
                            <div xmlns="http://www.w3.org/1999/xhtml" style="display:flex;justify-content:center;">
                              <input class="blank tiny" id="extra" inputmode="numeric" autocomplete="off" aria-label="extra (10 - 9)"/>
                            </div>
                          </foreignObject>
                        </g>
                      </svg>
                    </div>
                  </div>

                  <!-- Working (‚úÖ all ? replaced with real blanks pupils can fill) -->
                  <div class="workLines" aria-label="working">
                    <div class="eqRow">
                      <span id="w1a"></span>
                      <span class="dim">‚àí</span>
                      <span class="dim">9</span>
                    </div>

                    <div class="eqRow">
                      <span class="dim">=</span>
                      <span class="dim">(</span>
                      <span id="wM"></span>
                      <span class="dim">‚àí 10)</span>
                      <span class="dim">+ </span>
                      <input class="blank tiny" id="wExtra" inputmode="numeric" autocomplete="off" aria-label="extra in working"/>
                    </div>

                    <div class="eqRow">
                      <span class="dim">=</span>
                      <input class="blank tiny" id="wStep1" inputmode="numeric" autocomplete="off" aria-label="step 1 in working"/>
                      <span class="dim">+ </span>
                      <input class="blank tiny" id="wExtra2" inputmode="numeric" autocomplete="off" aria-label="extra again in working"/>
                    </div>

                    <div class="eqRow">
                      <span class="dim">=</span>
                      <input class="blank mid" id="wFinal" inputmode="numeric" autocomplete="off" aria-label="final in working"/>
                    </div>
                  </div>

                  <div class="finalPill" aria-label="final equation">
                    <span id="Mfinal">30</span>
                    <span class="op">‚àí</span>
                    <span class="op">9</span>
                    <span class="op">=</span>
                    <input class="blank" id="finalAns" inputmode="numeric" autocomplete="off" aria-label="final answer"/>
                  </div>
                </div>

                <!-- RIGHT step cards -->
                <div class="stepsCol" aria-label="step cards">
                  <div class="stepCard orange">
                    <div class="stepTitle orange"><span class="label">STEP 1</span></div>
                    <div class="stepDesc">Subtract more (subtract 10).</div>
                    <div class="stepEq">
                      <div class="row">
                        <span id="Mstep1">30</span>
                        <span class="dim">‚àí</span>
                        <span class="pillNum small">10</span>
                        <span class="dim">=</span>
                        <input class="blank tiny" id="step1" inputmode="numeric" autocomplete="off" aria-label="M - 10"/>
                      </div>
                    </div>
                  </div>

                  <div class="stepCard blue">
                    <div class="stepTitle blue"><span class="label">STEP 2</span></div>
                    <div class="stepDesc">Add the extra back.</div>
                    <div class="stepEq">
                      <div class="row">
                        <span class="pillNum small">10</span>
                        <span class="dim">‚àí</span>
                        <span class="pillNum small">9</span>
                        <span class="dim">=</span>
                        <input class="blank tiny" id="extra2" inputmode="numeric" autocomplete="off" aria-label="10 - 9"/>
                      </div>
                      <div class="row">
                        <input class="blank tiny" id="s2Step1" inputmode="numeric" autocomplete="off" aria-label="step1 (step 2 row)"/>
                        <span class="dim">+</span>
                        <input class="blank tiny" id="s2Extra" inputmode="numeric" autocomplete="off" aria-label="extra (step 2 row)"/>
                        <span class="dim">=</span>
                        <input class="blank tiny" id="s2Final" inputmode="numeric" autocomplete="off" aria-label="final (step 2 row)"/>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- BUTTON RAIL -->
            <div class="rail" aria-label="controls">
              <div class="railTitle">
                <span>Controls</span>
                <span style="color:var(--muted); font-size:11px;">Step-by-step</span>
              </div>

              <div class="railBtns">
                <button class="primary" id="btnCheck" type="button">Check</button>
                <button class="warn" id="btnNext" type="button">Next ‚ñ∂</button>
                <button class="ghost" id="btnClear" type="button">Clear</button>
                <button class="ghost" id="btnShowAll" type="button">Show all</button>
                <button class="good" id="btnNew" type="button">New</button>
              </div>

              <div class="railFooter">
                <div class="feedback" id="fb">
                  <strong>Goal:</strong> Fill in the blanks. Do ‚Äú‚àí10‚Äù first, then ‚Äú+1‚Äù.
                </div>
                <div class="creditInline">Designed by Lim Kim Sze ¬© 2026</div>
              </div>
            </div>

          </div>

          <div class="confetti" id="confetti"></div>
        </div>

        <!-- Hidden xAPI base -->
        <div id="xapiBase">
          <script src="xapiwrapper.min.js"></script>
          <script src="index.js"></script>
          <div><label>score</label><input id="score-input" value="0"></div>
          <div><label>feedback</label><input id="feedback-input" value="Well done!"></div>
          <button id="sendBtn" type="button">Send/Save</button>
        </div>

      </div>
    </div>
  </div>

  <!-- ‚úÖ Back to Main Menu (bottom centre) -->
  <button class="ghost" id="mainMenuBtn" type="button">‚¨Ö Back to Main Menu</button>

  <!-- Sound kit (generic) -->
  <script>
    let audioCtx = null;
    function ensureAudio(){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return audioCtx;
    }
    function beep(freq=660, ms=120, type="sine", gainVal=0.06){
      const ctx = ensureAudio();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gainVal;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=>{ try{o.stop();}catch(e){} }, ms);
    }
    function sfxCorrect(){ try{ beep(740,110,"triangle",0.07); setTimeout(()=>beep(990,130,"triangle",0.06),120);}catch(e){} }
    function sfxWrong(){ try{ beep(220,180,"sawtooth",0.05);}catch(e){} }
    function sfxClock(){ try{ beep(520,70,"square",0.03);}catch(e){} }
  </script>

  <script>
    const ACTIVITY_ID = "https://limkimsze-maker.github.io/SubtractMore_AddExtra_Method2/";
    const $ = (id)=>document.getElementById(id);

    // Problem state
    const state = { M:30, S:9, step1:20, extra:1, final:21 };

    // ‚úÖ All blanks pupils can fill (no more ?)
    const inputIds = [
      "step1","extra","extra2",
      "wExtra","wExtra2","wStep1","wFinal",
      "s2Step1","s2Extra","s2Final",
      "finalAns"
    ];

    // Reveal plan (Next button) ‚Äî fill the key ideas; sync will mirror across all related blanks
    const revealPlan = [
      { id:"step1",   val:()=>state.step1, msg:()=>`${state.M} ‚àí 10 = ${state.step1}.` },
      { id:"extra",   val:()=>state.extra, msg:()=>`10 ‚àí 9 = ${state.extra}.` },
      { id:"finalAns",val:()=>state.final, msg:()=>`${state.step1} + ${state.extra} = ${state.final}.` },
    ];
    let nextIndex = 0;

    function lockScroll(){
      try{
        document.addEventListener("wheel", (e)=>{ e.preventDefault(); }, {passive:false});
        document.addEventListener("touchmove", (e)=>{
          const t = e.target;
          if(t && (t.tagName==="INPUT" || t.tagName==="BUTTON")) return;
          e.preventDefault();
        }, {passive:false});
      }catch(e){}
    }

    function scaleStage(){
      const stage = $("stage");
      const wrap  = $("stageWrap");
      const panel = $("panel");

      const vv = window.visualViewport;
      const vw = (vv ? vv.width : window.innerWidth);
      const vh = (vv ? vv.height : window.innerHeight);

      const designW = 920, designH = 560;
      const margin = 10;

      const scale = Math.min((vw - margin*2)/designW, (vh - margin*2)/designH);
      const s = Math.max(0.24, scale);

      wrap.style.width  = (designW * s) + "px";
      wrap.style.height = (designH * s) + "px";
      stage.style.transform = `scale(${s})`;

      const small = (vw < 860) || (s < 0.78);
      panel.classList.toggle("smallMode", small);
    }
    window.addEventListener("resize", scaleStage);
    if(window.visualViewport){
      window.visualViewport.addEventListener("resize", scaleStage);
      window.visualViewport.addEventListener("scroll", scaleStage);
    }

    function clampInt(v){
      if(v === "" || v == null) return null;
      const n = parseInt(String(v).replace(/[^\d\-]/g,""),10);
      return Number.isFinite(n) ? n : null;
    }
    function setStatus(ok, msg){
      $("statusDot").classList.toggle("ok", !!ok);
      $("statusText").textContent = msg;
    }
    function setShowing(){
      const shown = Math.min(nextIndex, revealPlan.length);
      $("showingText").textContent = `Showing ${shown}/${revealPlan.length}`;
    }
    function resetFieldStyles(){
      inputIds.forEach(id=> $(id).classList.remove("okField","badField"));
    }
    function mark(id, ok){
      const el = $(id);
      el.classList.add(ok ? "okField" : "badField");
      return ok ? 1 : 0;
    }
    function setScore(score, feedback){
      $("scorePill").textContent = String(score);
      const scoreInput = $("score-input");
      const fbInput = $("feedback-input");
      if(scoreInput) scoreInput.value = String(score);
      if(fbInput) fbInput.value = String(feedback || "Well done!");
      try{
        if(typeof storeState === "function"){
          storeState({ score, feedback: String(feedback || "Well done!"), activityId: ACTIVITY_ID, ts: Date.now() });
        }
      }catch(e){}
    }

    function showConfetti(){
      const host = $("confetti");
      host.innerHTML = "";
      for(let i=0;i<42;i++){
        const el = document.createElement("i");
        el.style.left = (Math.random()*100) + "%";
        el.style.animationDuration = (900 + Math.random()*500) + "ms";
        el.style.background = (Math.random() < .5) ? "rgba(14,165,233,.95)" : "rgba(168,85,247,.90)";
        el.style.opacity = (0.75 + Math.random()*0.25).toFixed(2);
        host.appendChild(el);
      }
      setTimeout(()=>{ host.innerHTML=""; }, 1350);
    }

    function updateStaticTexts(){
      $("M").textContent = state.M;
      $("Mfinal").textContent = state.M;
      $("Mstep1").textContent = state.M;
      $("w1a").textContent = state.M;
      $("wM").textContent  = state.M;
    }

    // ‚úÖ Sync ‚Äúsame idea‚Äù blanks so pupils can type in ANY one and it mirrors everywhere
    // ‚úÖ NO auto-fill syncing while typing (students fill each blank themselves)
const G_STEP1 = ["step1","wStep1","s2Step1"];
const G_EXTRA = ["extra","extra2","wExtra","wExtra2","s2Extra"];
const G_FINAL = ["finalAns","wFinal","s2Final"];

function setVals(ids, value){
  ids.forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.value = (value==null ? "" : String(value));
  });
}
function clearVals(ids){ setVals(ids, ""); }

    function clearBlanks(){
  // clear every input (no syncing)
  inputIds.forEach(id=>{ const el=$(id); if(el) el.value=""; });

  resetFieldStyles();
  nextIndex = 0;
  setShowing();
  setStatus(false, "Not checked");
  $("fb").innerHTML = "<strong>Cleared.</strong> Fill in the blanks again.";
  setScore(0, "Well done!");
  if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
}


    function showAllAnswers(){
  // show answers across ALL blanks (but still NO syncing while typing)
  setVals(G_STEP1, state.step1);
  setVals(G_EXTRA, state.extra);
  setVals(G_FINAL, state.final);

  resetFieldStyles();
  inputIds.forEach(id=> $(id).classList.add("okField"));
  nextIndex = revealPlan.length;
  setShowing();

  $("fb").innerHTML = `<strong>All shown:</strong> ${state.M} ‚àí 10 = ${state.step1}, extra = ${state.extra}, final = ${state.final}.`;
  setStatus(false, "All answers shown");
  if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
}


    function revealNext(){
      if(nextIndex >= revealPlan.length){
        setStatus(true, "All steps shown");
        $("fb").innerHTML = "<strong>All shown.</strong> Press Clear to try again, or New for a new question.";
        if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
        setShowing();
        return;
      }
      const step = revealPlan[nextIndex];
      const el = $(step.id);
      el.value = String(step.val());

// Fill the related blanks for THIS revealed step (button-driven),
 // but there is still NO auto-sync when students type.
if(step.id === "step1") setVals(G_STEP1, step.val());
if(step.id === "extra") setVals(G_EXTRA, step.val());
if(step.id === "finalAns") setVals(G_FINAL, step.val());


      el.classList.remove("badField");
      el.classList.add("okField");

      $("fb").innerHTML = `<strong>Next:</strong> ${step.msg()}`;
      setStatus(false, `Showing ${nextIndex+1}/${revealPlan.length}`);
      nextIndex++;
      setShowing();
      if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxClock();
    }

    function setProblem(M){
      state.M = M;
      state.S = 9;
      state.step1 = M - 10;
      state.extra = 1;         // 10 - 9
      state.final = M - 9;

      updateStaticTexts();
      clearBlanks();
      $("fb").innerHTML = "<strong>Goal:</strong> Fill in the blanks. Do ‚Äú‚àí10‚Äù first, then ‚Äú+1‚Äù.";
    }

    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function newQuestion(){
      const M = randInt(20, 99);
      setProblem(M);
    }

    function checkAll(){
      resetFieldStyles();

      const vStep1 = clampInt($("step1").value);
      const vExtra = clampInt($("extra").value);
      const vFinal = clampInt($("finalAns").value);

      // since groups are synced, we can validate all blanks easily
      let okCount = 0;
      const expected = {
        step1: state.step1,
        extra: state.extra,
        final: state.final
      };

      // STEP1 group
      okCount += mark("step1",   clampInt($("step1").value)   === expected.step1);
      okCount += mark("wStep1",  clampInt($("wStep1").value)  === expected.step1);
      okCount += mark("s2Step1", clampInt($("s2Step1").value) === expected.step1);

      // EXTRA group
      okCount += mark("extra",   clampInt($("extra").value)   === expected.extra);
      okCount += mark("extra2",  clampInt($("extra2").value)  === expected.extra);
      okCount += mark("wExtra",  clampInt($("wExtra").value)  === expected.extra);
      okCount += mark("wExtra2", clampInt($("wExtra2").value) === expected.extra);
      okCount += mark("s2Extra", clampInt($("s2Extra").value) === expected.extra);

      // FINAL group
      okCount += mark("finalAns", clampInt($("finalAns").value) === expected.final);
      okCount += mark("wFinal",   clampInt($("wFinal").value)   === expected.final);
      okCount += mark("s2Final",  clampInt($("s2Final").value)  === expected.final);

      const total = 3 + 5 + 3; // 11

      if(okCount === total){
        setStatus(true, "‚úÖ All correct!");
        $("fb").innerHTML = "<strong>Correct!</strong> Subtract 10, then add 1. üéâ";
        if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxCorrect();
        showConfetti();
        setScore(1, "Success");
      }else{
        setStatus(false, `Try again (${okCount}/${total} correct)`);
        $("fb").innerHTML = `<strong>Keep going.</strong> First do ${state.M} ‚àí 10, then add 1 (because 10 ‚àí 9 = 1).`;
        if(sessionStorage.getItem("UFCO-audio-unlocked")==="1") sfxWrong();
        setScore(0, "Well done!");
      }
    }

    window.addEventListener("DOMContentLoaded", ()=>{
      lockScroll();

      // ‚úÖ Sound by default (resume on first interaction)
      sessionStorage.setItem("UFCO-audio-unlocked","1");
      (function(){
        let armed = false;
        const arm = () => {
          if(armed) return;
          armed = true;
          try{
            const ctx = ensureAudio();
            ctx.resume && ctx.resume().catch(()=>{});
          }catch(e){}
        };
        window.addEventListener("pointerdown", arm, { once:true, capture:true });
        window.addEventListener("keydown", arm, { once:true, capture:true });
      })();

      $("btnCheck").addEventListener("click", checkAll);
      $("btnNext").addEventListener("click", revealNext);
      $("btnClear").addEventListener("click", clearBlanks);
      $("btnShowAll").addEventListener("click", showAllAnswers);
      $("btnNew").addEventListener("click", newQuestion);

      inputIds.forEach(id=>{
        $(id).addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); checkAll(); }
        });
      });

      scaleStage();
      setProblem(30); // starts with 30 ‚àí 9
      setShowing();
    });
  </script>

  <!-- ‚úÖ Back to Main Menu button wiring + non-blocking adjuster -->
  <script>
    (function(){
      const btn = document.getElementById("mainMenuBtn");
      const wrap = document.getElementById("stageWrap");
      if(!btn) return;

      btn.addEventListener("click", ()=>{
        window.location.href = "https://limkimsze-maker.github.io/P3_Mental_Sum_Challenge/";
      });

      // Try to keep the button from overlapping the stage (only if space is tight).
      function adjustIfOverlap(){
        if(!wrap) return;
        wrap.style.transform = ""; // reset

        const wr = wrap.getBoundingClientRect();
        const br = btn.getBoundingClientRect();

        const gapBottom = window.innerHeight - wr.bottom;
        const need = br.height + 12; // space needed below stage
        if(gapBottom >= need) return;

        const lift = need - gapBottom;
        const gapTop = wr.top;
        const liftClamped = Math.min(lift, Math.max(0, gapTop - 6));
        if(liftClamped > 0){
          wrap.style.transform = `translateY(-${liftClamped}px)`;
        }
      }

      window.addEventListener("resize", ()=>setTimeout(adjustIfOverlap, 0));
      if(window.visualViewport){
        window.visualViewport.addEventListener("resize", ()=>setTimeout(adjustIfOverlap, 0));
        window.visualViewport.addEventListener("scroll", ()=>setTimeout(adjustIfOverlap, 0));
      }
      window.addEventListener("DOMContentLoaded", ()=>setTimeout(adjustIfOverlap, 80));
    })();
  </script>

  <script src="https://limkimsze-maker.github.io/assets/nav.js"></script>
</body>
</html>
